---
- name: Check if keystore exists in role
  stat:
    path: '{{ role_path }}/files/{{ solr_ssl_key_store_name }}'
  delegate_to: localhost
  register: keystore_file

- name: Copy keystore file
  copy:
    src: '{{ role_path }}/files/{{ solr_ssl_key_store_name }}'
    dest: '{{ solr_ssl_key_store }}'
    owner: '{{ solr_user }}'
    group: '{{ solr_group }}'
    mode: 0644
  become: True
  when: keystore_file.stat.exists

- name: Create private certificate
  openssl_privatekey:
    path: '{{ local_pkey_file_path }}/{{ solr_local_pkey_file_name }}'
    size: '{{ solr_ssl_key_size | int }}'
  become: True
  when: not keystore_file.stat.exists

- name: Create CSR
  openssl_csr:
    path: '/tmp/{{ solr_local_cert_file_name }}.csr'
    privatekey_path: '{{ local_pkey_file_path }}/{{ solr_local_pkey_file_name }}'
    common_name: '{{ solr_ca_domain }}'
  become: True
  when: not keystore_file.stat.exists

- name: Create certificates for keystore
  openssl_certificate:
    csr_path: '/tmp/{{ solr_local_cert_file_name }}.csr'
    path: '{{ local_cert_file_path }}/{{ solr_local_cert_file_name }}'
    privatekey_path: '{{ local_pkey_file_path }}/{{ solr_local_pkey_file_name }}'
    provider: '{{ solr_ssl_certificate_provider }}'
    force: True
  become: True
  changed_when: False
  when: not keystore_file.stat.exists

- name: Create keystore
  include_tasks: >-
    {{ ansible_version.full is version("2.7", "<") |
    ternary(ansible_system + "_keystore_old.yml", ansible_system + "_keystore_new.yml") }}
  when:
    - not keystore_file.stat.exists
